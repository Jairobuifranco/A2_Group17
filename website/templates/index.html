<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Local Concerts — Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='style/styles.css') }}"/>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">
        <i class="bi bi-music-note-beamed me-1"></i>Local<span>Concerts</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link active" href="{{ url_for('main.index') }}" aria-current="page">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.create_event') }}">Create Event</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('main.bookings') }}">Bookings</a></li>
          <!-- Genres dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Genres</a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item{% if not selected_genre %} active{% endif %}"
                   href="{{ url_for('main.index', q=search_query if search_query else None) }}">
                  All Genres
                </a>
              </li>
              <li><hr class="dropdown-divider"></li>
              {% for genre in genres %}
                <li>
                  <a class="dropdown-item d-flex justify-content-between align-items-center{% if selected_genre and selected_genre.lower() == genre.lower() %} active{% endif %}"
                     href="{{ url_for('main.index', genre=genre, q=search_query if search_query else None) }}">
                    <span>{{ genre }}</span>
                    {% if selected_genre and selected_genre.lower() == genre.lower() %}
                      <i class="bi bi-check-lg"></i>
                    {% endif %}
                  </a>
                </li>
              {% endfor %}
            </ul>
          </li>
        </ul>

        <!-- Search bar -->
        <form class="d-flex" role="search" action="{{ url_for('main.index') }}" method="get">
          <input class="form-control me-2" type="search" name="q" placeholder="Search concerts" value="{{ search_query }}">
          <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
        </form>

        <!-- Auth buttons -->
        <div class="ms-3 d-flex align-items-center gap-2">
          {% if current_user.is_authenticated %}
            <span class="badge text-bg-success">Signed in as {{ current_user.name }}</span>
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('auth.logout') }}">Log out</a>
          {% else %}
            <a class="btn btn-primary btn-sm{% if active_tab != 'register' %} active{% endif %}" aria-current="{{ 'page' if active_tab != 'register' else 'false' }}" href="{{ url_for('auth.login') }}">Log in</a>
            <a class="btn btn-outline-secondary btn-sm{% if active_tab == 'register' %} active{% endif %}" aria-current="{{ 'page' if active_tab == 'register' else 'false' }}" href="{{ url_for('auth.login', tab='register') }}">Sign up</a>
          {% endif %}
        </div>
      </div>
    </div>
  </nav>

  <!-- Carousel -->
  {% if featured_events %}
    <section class="mb-2">
      <div id="popularCarousel" class="carousel slide hero-carousel" data-bs-ride="carousel">
        <div class="carousel-inner">
          {% for featured in featured_events %}
            {% set image_url = featured.image_url %}
            {% if image_url %}
              {% if image_url.startswith('http') %}
                {% set slide_image = image_url %}
              {% else %}
                {% set slide_image = url_for('static', filename=image_url.lstrip('/').replace('static/', '')) %}
              {% endif %}
            {% else %}
              {% set slide_image = url_for('static', filename='img/hero1.jpg') %}
            {% endif %}
            <div class="carousel-item {% if loop.first %}active{% endif %}">
              <img class="w-100 h-100 position-absolute top-0 start-0 carousel-img" src="{{ slide_image }}" alt="{{ featured.title }}">
              <div class="carousel-caption text-start">
                <span class="badge bg-warning text-dark mb-2">{{ 'Upcoming' if not featured.is_expired else 'Recently Added' }}</span>
                <h2 class="fw-bold">{{ featured.title }}</h2>
                <p class="mb-1">
                  <i class="bi bi-geo-alt"></i>
                  {{ featured.venue }} •
                  {% if featured.start_time %}
                    {{ featured.start_time.strftime('%a %I:%M %p') }}
                  {% else %}
                    TBA
                  {% endif %}
                </p>
                <a href="{{ url_for('main.event', event_id=featured.id) }}" class="btn btn-primary btn-sm">View Event</a>
              </div>
            </div>
          {% endfor %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#popularCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span><span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#popularCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span><span class="visually-hidden">Next</span>
        </button>
      </div>
    </section>
  {% endif %}

  <!-- static filters toolbar -->
  <div class="sticky-toolbar py-3 bg-white border-top border-bottom">
    <div class="container d-flex flex-wrap gap-2 align-items-center">
      <span class="text-muted small"><i class="bi bi-funnel"></i> Quick Filters:</span>
      <div class="btn-group" role="group" aria-label="Filters">
        <a class="btn btn-outline-secondary btn-sm{% if not quick_filter %} active{% endif %}"
           href="{{ url_for('main.index', genre=selected_genre if selected_genre else None, q=search_query if search_query else None) }}">
          All
        </a>
        {% for value, label in quick_filters %}
          <a class="btn btn-outline-secondary btn-sm{% if quick_filter == value %} active{% endif %}"
             href="{{ url_for('main.index', quick=value, genre=selected_genre if selected_genre else None, q=search_query if search_query else None) }}">
            {{ label }}
          </a>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Events grid (all link to the same event.html) -->
  <main class="container py-4">
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-3 gap-2">
      <h3 class="mb-0">All Concerts</h3>
      {% if search_query or selected_genre or quick_filter_label %}
        <div class="text-muted small d-flex align-items-center gap-2">
          <div class="d-flex flex-wrap gap-2">
            {% if search_query %}
              <span><i class="bi bi-search"></i> Results for "<strong>{{ search_query }}</strong>"</span>
            {% endif %}
            {% if selected_genre %}
              <span><i class="bi bi-disc"></i> Genre: <strong>{{ selected_genre }}</strong></span>
            {% endif %}
            {% if quick_filter_label %}
              <span><i class="bi bi-lightning-charge"></i> Quick Filter: <strong>{{ quick_filter_label }}</strong></span>
            {% endif %}
          </div>
          <a class="btn btn-link btn-sm text-decoration-none" href="{{ url_for('main.index') }}">Clear filters</a>
        </div>
      {% endif %}
    </div>

    {% macro event_card(event) -%}
      {% set card_image = event.image_url %}
      {% if card_image %}
        {% if card_image.startswith('http') %}
          {% set card_image = card_image %}
        {% else %}
          {% set card_image = url_for('static', filename=card_image.lstrip('/').replace('static/', '')) %}
        {% endif %}
      {% else %}
        {% set card_image = url_for('static', filename='img/hero1.jpg') %}
      {% endif %}
      {% set status_label = event.display_status %}
      {% set status_lower = (status_label or '')|lower %}
      {% set badge_class = 'secondary' %}
      {% if 'open' in status_lower %}
        {% set badge_class = 'success' %}
      {% elif 'sold' in status_lower %}
        {% set badge_class = 'danger' %}
      {% elif 'cancel' in status_lower %}
        {% set badge_class = 'dark' %}
      {% elif 'expired' in status_lower %}
        {% set badge_class = 'secondary' %}
      {% elif 'inactive' in status_lower %}
        {% set badge_class = 'secondary' %}
      {% endif %}
      <div class="col">
        <div class="card h-100 shadow-sm">
          <img src="{{ card_image }}" class="card-img-top" alt="{{ event.title }}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <h5 class="card-title mb-1">{{ event.title }}</h5>
              {% if status_label %}
                <span class="badge text-bg-{{ badge_class }}">{{ status_label }}</span>
              {% endif %}
            </div>
            <p class="mb-1"><i class="bi bi-calendar-event"></i> {{ event.start_time.strftime('%a, %b %d') if event.start_time else 'TBA' }}</p>
            <p class="mb-1"><i class="bi bi-clock"></i>
              {% if event.start_time and event.end_time %}
                {{ event.start_time.strftime('%H:%M') }} – {{ event.end_time.strftime('%H:%M') }}
              {% else %}
                TBA
              {% endif %}
            </p>
            <p class="mb-2"><i class="bi bi-geo-alt"></i> {{ event.venue }}</p>
            <div class="d-flex gap-1 flex-wrap">
            <span class="badge text-bg-light border small">General ${{ "%.2f"|format(event.general_price) }}</span>
            <span class="badge text-bg-warning border small">VIP ${{ "%.2f"|format(event.vip_price) }}</span>
        </div>
            {% if event.is_expired %}
              <p class="text-muted small mb-0 mt-2"><i class="bi bi-hourglass-bottom"></i> Event ended</p>
            {% endif %}
          </div>
          <div class="card-footer bg-white border-0">
            <div class="d-grid gap-2">
              <a href="{{ url_for('main.event', event_id=event.id) }}" class="btn btn-primary">View Details</a>
            </div>
          </div>
        </div>
      </div>
    {%- endmacro %}

    {% if upcoming_events %}
      <div class="row g-4 row-cols-1 row-cols-md-2 row-cols-lg-3">
        {% for event in upcoming_events %}
          {{ event_card(event) }}
        {% endfor %}
      </div>
    {% endif %}

    {% if past_events %}
      <div class="my-4 position-relative text-center">
        <hr class="position-absolute top-50 start-0 end-0 translate-middle-y bg-secondary-subtle opacity-75"/>
        <span class="position-relative px-3 text-muted small text-uppercase bg-white">
          <i class="bi bi-clock-history me-1"></i>Past Events
        </span>
      </div>
      <div class="row g-4 row-cols-1 row-cols-md-2 row-cols-lg-3">
        {% for event in past_events %}
          {{ event_card(event) }}
        {% endfor %}
      </div>
    {% endif %}

    {% if not upcoming_events and not past_events %}
      <div class="row">
        <div class="col">
          <div class="alert alert-info" role="alert">
            {% if search_query or selected_genre or quick_filter_label %}
              <i class="bi bi-info-circle me-1"></i>No events match{% if search_query %} "<strong>{{ search_query }}</strong>"{% endif %}{% if selected_genre %}{% if search_query %} and{% else %} {% endif %}the genre "<strong>{{ selected_genre }}</strong>"{% endif %}{% if quick_filter_label %}{% if search_query or selected_genre %} with{% else %} {% endif %}the quick filter "<strong>{{ quick_filter_label }}</strong>"{% endif %}.
              <a class="alert-link" href="{{ url_for('main.index') }}">Clear filters</a> or adjust your filters.
            {% else %}
              <i class="bi bi-info-circle me-1"></i>No events found. Create one to get started.
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}
  </main>

  <footer class="py-4 bg-white border-top">
    <div class="container d-flex justify-content-between align-items-center">
      <span class="text-muted small">&copy; <span>2025</span> LocalConcerts</span>
      <a class="small text-decoration-none" href="#">Terms & Privacy</a>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
